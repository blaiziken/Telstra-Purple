<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>Blog Single - Telstra Purple</title>
  <meta content="" name="description">
  <meta content="" name="keywords">

  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Raleway:300,300i,400,400i,500,500i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/animate.css/animate.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
  <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
  <link href="assets/vendor/remixicon/remixicon.css" rel="stylesheet">
  <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

  <!-- Template Main CSS File -->
  <link href="assets/css/blog.css" rel="stylesheet">

  <!-- =======================================================
  * Template Name: Sailor - v4.3.0
  * Template URL: https://bootstrapmade.com/sailor-free-bootstrap-theme/
  * Author: BootstrapMade.com
  * License: https://bootstrapmade.com/license/
  ======================================================== -->
</head>

<body>

  <!-- ======= Header ======= -->
  <header id="header" class="fixed-top d-flex align-items-center">
    <div class="container d-flex align-items-center">

      <h1 class="logo me-auto"><a href="index.html">Telstra Purple</a></h1>
      <!-- Uncomment below if you prefer to use an image logo -->
      <!-- <a href="index.html" class="logo me-auto"><img src="assets/img/logo.png" alt="" class="img-fluid"></a>-->

      <nav id="navbar" class="navbar">
        <ul>
          <li><a href="index.html">Home</a></li>

          <li class="dropdown"><a href="#"><span>About</span> <i class="bi bi-chevron-down"></i></a>
            <ul>
              <li><a href="about.html">About</a></li>
              <li><a href="team.html">Team</a></li>
              <li><a href="testimonials.html">Testimonials</a></li>

              <li class="dropdown"><a href="#"><span>Deep Drop Down</span> <i class="bi bi-chevron-right"></i></a>
                <ul>
                  <li><a href="#">Deep Drop Down 1</a></li>
                  <li><a href="#">Deep Drop Down 2</a></li>
                  <li><a href="#">Deep Drop Down 3</a></li>
                  <li><a href="#">Deep Drop Down 4</a></li>
                  <li><a href="#">Deep Drop Down 5</a></li>
                </ul>
              </li>
            </ul>
          </li>
          <li><a href="services.html">Services</a></li>
          <li><a href="portfolio.html">Portfolio</a></li>
          <li><a href="pricing.html">Pricing</a></li>
          <li><a href="blog.html" class="active">Blog</a></li>

          <li><a href="contact.html">Contact</a></li>
          <li><a href="index.html" class="getstarted">Get Started</a></li>
        </ul>
        <i class="bi bi-list mobile-nav-toggle"></i>
      </nav><!-- .navbar -->

    </div>
  </header><!-- End Header -->

  <main id="main">

    <!-- ======= Breadcrumbs ======= -->
    <section id="breadcrumbs" class="breadcrumbs">
      <div class="container">

        <div class="d-flex justify-content-between align-items-center">
          <h2>Blog Single</h2>
          <ol>
            <li><a href="index.html">Home</a></li>
            <li><a href="blog.html">Blog</a></li>
            <li>Blog Single</li>
          </ol>
        </div>

      </div>
    </section><!-- End Breadcrumbs -->

    <!-- ======= Blog Single Section ======= -->
    <section id="blog" class="blog">
      <div class="container" data-aos="fade-up">

        <div class="row">

          <div class="col-lg-8 entries">

            <article class="entry entry-single">

              <div class="entry-img">
                <img src="assets/img/blog/blog-1.jpg" alt="" class="img-fluid">
              </div>

              <h2 class="entry-title">
                <a href="blog-single.html">Design Patterns for Handling Long-running Tasks</a>
              </h2>

         
              <div class="entry-content">
                <p>
                  Cloud services suggest new ways for implementing our applications. However, for some long-running jobs like generating a PDF or performing a complex calculation, there is not much we can do to make them run faster rather than scaling up/out.


                  In this article, we look at two patterns for handling such requests.
                </p>

                <h1>Introduction</h1>
          
                  <p>
                    In today's world, users expect applications or websites to be fast, and usually, a latency of around 100 milliseconds is considered reasonable. We can improve the latency of services by avoiding chatty APIs or leveraging materialised views for more expensive queries.
                    However, for some long-running jobs like generating a PDF or performing a complex calculation, there is not much we can do to make them run faster rather than scaling up/out. In this article, I'm going to take a look at two patterns for handling such requests.
                  </p>
                

                <p>
                  In a typical web application, most of the communications between the client and the server are synchronous. By synchronous here, I mean the response arrives back over the same connection. The client (i.e. the browser) sends an HTTP request to the back-end, the back-end returns the result in the same call. This works well for quick resources that the user doesn't notice any significant delays, like fetching some data from the database.

                  It is also common that some services depend on other services to compose their response, leading to a greater overall latency from the users perspective. However, we should resolve such issues using different patterns like materialised view or caching or by scaling out the backend which is out of the context of this article.

                  There are other types of services that their response cannot be cached and needs to be generated specifically for the incoming request. The latency in this scenario could come from many factors such as dependency on other external services or the task itself being a CPU-intensive task. In this category we can divide our calls into two sub-categories:
                </p>

                <h1>Outbox Pattern</h1>
                <p>
                  Fixing the request without a response is simple. The first step is to return immediately to the client and let the backend continue processing in the background. Please note that we are not awaiting on <code>SendEmailAsync</code>
                </p>
                <pre><code class="language-csharp">public static IActionResult Run([HttpTrigger] HttpRequest request)
                  {
                    ...
                    SendEmailAsync();
                    return new AcceptedResult();
                  }
                  </code></pre>

                  <p>This code returns immediately with <code>HTTP 202 (ACCEPTED)</code> so the user doesn't need to wait until the email is sent. However, if the email service is unavailable, depending on the implementation of <code>SendEmailAsync</code> method, the user either receives an error or the email will never be sent. Both of these outcomes are not ideal. Unless sending the email is the primary intention of the user, returning an error is not a good experience since users should be able to submit successfully regardless of the underlying services which don't affect them directly. We can resolve this problem by using the "Outbox" pattern which guarantees at-least-once delivery.</p>



                <img src="assets/img/blog/blog-inside-post.png" class="img-fluid" alt="">

                
                <p>In the above diagram:</p>
                <ol>
                  <li>User sends the request.</li>
                  <li>Back-end service enqueues a message to the queue with email payload.</li>
                  <li>Regardless of the email service status, the user immediately receives an <code>ACCEPTED</code> response.</li>
                  <li>Email service checks for messages and sends the email.</li>
                  </ol>

              
                  <p>In the following code we push the request of sending email into the queue, and return immediately:</p>
                  <pre><code class="language-csharp">public static async Task&lt;IActionResult&gt; Run(
                    [HttpTrigger] HttpRequest request,
                    [ServiceBus("emailqueue", Connection = "connection")] IAsyncCollector&lt;Message&gt; emailMessage)
                  {
                    ...
                    Message message = new Message(GetBytes(emailPayload));
                    await emailMessage.AddAsync(message); 
                  
                    return new AcceptedResult();
                  }
                  </code></pre>
            
                  <p>You may argue that if the message broker is temporarily unavailable then again we're facing the same issue. For addressing this concern, we can use a local database with an outbox table and store the message first in this database then another service enqueues the messages from this database:</p>

                  <pre><code class="language-csharp">public static async Task&lt;IActionResult&gt; Run(
                    [HttpTrigger] HttpRequest request,
                    [ServiceBus("emailqueue", Connection = "connection")] IAsyncCollector&lt;Message&gt; emailMessage)
                  {
                    ...
                    var outboxItem = new OutboxItem(emailPayload);
                    await outboxRepository.Insert(outboxItem);
                  
                    return new AcceptedResult();
                  }
                  </code></pre>
                  <p>As you can see with this change our service doesn't rely on the queue for completing its job and we write the messages to the outbox table of the local database. Since the database is local to our service, there is a lower chance that the database is unavailable comparing to an external entity that has to be accessed over the network.

                    The following function will trigger on queue event and will send the email. In this case, if the email sender service is offline we won't lose the message and it'll eventually send the email once it's back online.</p>

                    <pre><code class="language-csharp">public static void Run(
                      [ServiceBusTrigger("emailqueue", Connection = "connection")] Message emailMessage)
                    {
                      SendEmailAsync(emailMessage);
                    }
                    </code></pre>
                    <p>Outbox pattern is a simple yet powerful pattern, instead of performing the action directly we push it in a queue and offload the execution of the job to another service.
                    We can use this pattern everywhere we need a guaranteed delivery.</p>




          
                    <h1>Asynchronous Request-Reply Pattern</h1>
                <p>
                  Similar to the outbox pattern, in this pattern we are going to decouple the backend and the processing worker. 
                  But since we want to provide a way for the frontend to query about the result of the task, we need to return a status check endpoint to the client as well.
                </p>
                <img src="assets/img/blog/blog-inside-post1.png" class="img-fluid" alt="">

                <p>In the above diagram:</p>
                <ol>
                  <li>User sends the request.</li>
                  <li>Back-end service enqueues a message to the queue with pdf payload.</li>
                  <li>User receives an <code>ACCEPTED</code> response with the check status URL.</li>
                  <li>PDF generator service fetches the request messages and generates the PDF.</li>
                  <li>PDF generator service stores the PDF into Blob storage.</li>
                  <li>Client calls the request status endpoint,</li>
                  <li>Request status checker tries to get the PDF.</li>
                  <li>If the PDF exists, it returns it. Otherwise, it returns <code>ACCEPTED</code> response and the client needs to check again.</li>
                  </ol>

                  <p>In the following code, we enqueue the message and add the status URL to the <code>location</code> header of the response:</p>
                  <pre><code class="language-csharp">public static async Task&lt;IActionResult&gt; Run(
                    [HttpTrigger] HttpRequest request,
                    [ServiceBus("pdfqueue", Connection = "connection")] IAsyncCollector&lt;Message&gt; pdfMessage)
                  {
                    ...
                    string requestId = Guid.NewGuid().ToString();
                    string host = Environment.GetEnvironmentVariable("WEBSITE_HOSTNAME");
                    string statusUrl = $"http://{host}/api/RequestStatus/{requestId}";
                  
                    Message message = new Message(GetBytes(pdfPayload));
                    message.UserProperties["RequestId"] = requestId;
                    message.UserProperties["RequestSubmittedAt"] = DateTime.UtcNow;
                    message.UserProperties["RequestStatusURL"] = statusUrl;
                    await pdfMessage.AddAsync(message); 
                  
                    return new AcceptedResult(statusUrl);
                  }
                  </code></pre>

                  <p>The following code, checks for the generated PDF in the blob storage, if the PDF exists it returns it otherwise it returns <code>ACCEPTED</code> response with the status check URI. Please note that instead of a fixed retry time, we can implement a backoff function to avoid hitting this endpoint frequently.</p>
                  <pre><code class="language-csharp">public static async Task&lt;IActionResult&gt; Run(
                    [HttpTrigger(Route = "RequestStatus/{id}"))] HttpRequest request,
                    [Blob("pdfs/{id}.pdf", FileAccess.Read, Connection = "connection")] CloudBlockBlob pdfBlob,
                    string id
                  {
                    ...
                    if (await pdfBlob.ExistsAsync())
                    {
                      return (ActionResult)new OkObjectResult(await pdfBlob.DownloadTextAsync());
                    }
                  
                    string host = Environment.GetEnvironmentVariable("WEBSITE_HOSTNAME");
                    string statusUrl = $"http://{host}/api/RequestStatus/{id}";
                    return (ActionResult)new AcceptedResult(statusUrl) { RetryAfter = 10 };
                  }
                  </code></pre>
                  <p>The following code receives the queue message and generates the PDF asynchronously then stores it in storage so the client can download it:</p>

                  <pre><code class="language-csharp">public static void Run(
                    [ServiceBusTrigger("pdfqueue", Connection = "connection")] Message message
                    [Blob("pdfs", FileAccess.ReadWrite, Connection = "connection")] CloudBlobContainer pdfBlob)
                  
                  {
                    var id = message.UserProperties["RequestId"] as string;
                    var pdf = GeneratePdf(queueMessage);
                    CloudBlockBlob cloudBlockBlob = pdfBlob.GetBlockBlobReference($"{id}.pdf");
                    cloudBlockBlob.UploadFromByteArrayAsync(pdf, 0, pdf.Length);
                  }
                  </code></pre>
                  <h1>Conclusion</h1>
                  <p>Cloud services suggest new ways for implementing our applications.
                  They encourage us to use more decoupled services talking to each other.
                  However, we should be careful as we've seen this separation brings additional complexity.
                  Before using any patterns, we should consider all the impacts they're going to have on our application. 
                  Even the slightest change in the requirements may make these patterns unsuitable.</p>

                  <p></p>
                  <p></p>

    
                </div>
               
                <div class="blog-pagination">
                  <ul class="justify-content-center">
                    <li><a href="blog.html">Go back to blog</a></li>
                   
                  </ul>
                </div>
    
            </article><!-- End blog entry -->
 
            </div><!-- End blog author bio -->

            

          <div class="col-lg-4">

            <div class="sidebar">

              <h3 class="sidebar-title">Search</h3>
              <div class="sidebar-item search-form">
                <form action="">
                  <input type="text">
                  <button type="submit"><i class="bi bi-search"></i></button>
                </form>
              </div><!-- End sidebar search formn-->

              <h3 class="sidebar-title">Categories</h3>
              <div class="sidebar-item categories">
                <ul>
                  <li><a href="#">General <span>(25)</span></a></li>
                  <li><a href="#">Lifestyle <span>(12)</span></a></li>
                  <li><a href="#">Travel <span>(5)</span></a></li>
                  <li><a href="#">Design <span>(22)</span></a></li>
                  <li><a href="#">Creative <span>(8)</span></a></li>
                  <li><a href="#">Educaion <span>(14)</span></a></li>
                </ul>
              </div><!-- End sidebar categories-->

              <h3 class="sidebar-title">Recent Posts</h3>
              <div class="sidebar-item recent-posts">
                <div class="post-item clearfix">
                  <img src="assets/img/blog/blog-recent-1.jpg" alt="">
                  <h4><a href="blog-single.html">Nihil blanditiis at in nihil autem</a></h4>
                  <time datetime="2020-01-01">Jan 1, 2020</time>
                </div>

                <div class="post-item clearfix">
                  <img src="assets/img/blog/blog-recent-2.jpg" alt="">
                  <h4><a href="blog-single.html">Quidem autem et impedit</a></h4>
                  <time datetime="2020-01-01">Jan 1, 2020</time>
                </div>

                <div class="post-item clearfix">
                  <img src="assets/img/blog/blog-recent-3.jpg" alt="">
                  <h4><a href="blog-single.html">Id quia et et ut maxime similique occaecati ut</a></h4>
                  <time datetime="2020-01-01">Jan 1, 2020</time>
                </div>

                <div class="post-item clearfix">
                  <img src="assets/img/blog/blog-recent-4.jpg" alt="">
                  <h4><a href="blog-single.html">Laborum corporis quo dara net para</a></h4>
                  <time datetime="2020-01-01">Jan 1, 2020</time>
                </div>

                <div class="post-item clearfix">
                  <img src="assets/img/blog/blog-recent-5.jpg" alt="">
                  <h4><a href="blog-single.html">Et dolores corrupti quae illo quod dolor</a></h4>
                  <time datetime="2020-01-01">Jan 1, 2020</time>
                </div>

              </div><!-- End sidebar recent posts-->

              <h3 class="sidebar-title">Tags</h3>
              <div class="sidebar-item tags">
                <ul>
                  <li><a href="#">App</a></li>
                  <li><a href="#">IT</a></li>
                  <li><a href="#">Business</a></li>
                  <li><a href="#">Mac</a></li>
                  <li><a href="#">Design</a></li>
                  <li><a href="#">Office</a></li>
                  <li><a href="#">Creative</a></li>
                  <li><a href="#">Studio</a></li>
                  <li><a href="#">Smart</a></li>
                  <li><a href="#">Tips</a></li>
                  <li><a href="#">Marketing</a></li>
                </ul>
              </div><!-- End sidebar tags-->

            </div><!-- End sidebar -->

          </div><!-- End blog sidebar -->

        </div>

      </div>
    </section><!-- End Blog Single Section -->

  </main><!-- End #main -->

  <!-- ======= Footer ======= -->
  <footer id="footer">
    <div class="footer-top">
      <div class="container">
        <div class="row">

          <div class="col-lg-3 col-md-6">
            <div class="footer-info">
              <h3>Telstra Purple</h3>
              <p>
                A108 Adam Street <br>
                NY 535022, USA<br><br>
                <strong>Phone:</strong> +1 5589 55488 55<br>
                <strong>Email:</strong> info@example.com<br>
              </p>
              <div class="social-links mt-3">
                <a href="#" class="twitter"><i class="bx bxl-twitter"></i></a>
                <a href="#" class="facebook"><i class="bx bxl-facebook"></i></a>
                <a href="#" class="instagram"><i class="bx bxl-instagram"></i></a>
                <a href="#" class="google-plus"><i class="bx bxl-skype"></i></a>
                <a href="#" class="linkedin"><i class="bx bxl-linkedin"></i></a>
              </div>
            </div>
          </div>

          <div class="col-lg-2 col-md-6 footer-links">
            <h4>Useful Links</h4>
            <ul>
              <li><i class="bx bx-chevron-right"></i> <a href="#">Home</a></li>
              <li><i class="bx bx-chevron-right"></i> <a href="#">About us</a></li>
              <li><i class="bx bx-chevron-right"></i> <a href="#">Services</a></li>
              <li><i class="bx bx-chevron-right"></i> <a href="#">Terms of service</a></li>
              <li><i class="bx bx-chevron-right"></i> <a href="#">Privacy policy</a></li>
            </ul>
          </div>

          <div class="col-lg-3 col-md-6 footer-links">
            <h4>Our Services</h4>
            <ul>
              <li><i class="bx bx-chevron-right"></i> <a href="#">Web Design</a></li>
              <li><i class="bx bx-chevron-right"></i> <a href="#">Web Development</a></li>
              <li><i class="bx bx-chevron-right"></i> <a href="#">Product Management</a></li>
              <li><i class="bx bx-chevron-right"></i> <a href="#">Marketing</a></li>
              <li><i class="bx bx-chevron-right"></i> <a href="#">Graphic Design</a></li>
            </ul>
          </div>

          <div class="col-lg-4 col-md-6 footer-newsletter">
            
            <form action="" method="post">
              <input type="email" name="email"><input type="submit" value="Subscribe">
            </form>

          </div>

        </div>
      </div>
    </div>

    <div class="container">
      <div class="copyright">
        &copy; Copyright <strong><span>Sailor</span></strong>. All Rights Reserved
      </div>
      <div class="credits">
        <!-- All the links in the footer should remain intact. -->
        <!-- You can delete the links only if you purchased the pro version. -->
        <!-- Licensing information: https://bootstrapmade.com/license/ -->
        <!-- Purchase the pro version with working PHP/AJAX contact form: https://bootstrapmade.com/sailor-free-bootstrap-theme/ -->
        Designed by <a href="https://bootstrapmade.com/">BootstrapMade</a>
      </div>
    </div>
  </footer><!-- End Footer -->

  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Vendor JS Files -->
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
  <script src="assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
  <script src="assets/vendor/php-email-form/validate.js"></script>
  <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>
  <script src="assets/vendor/waypoints/noframework.waypoints.js"></script>

  <!-- Template Main JS File -->
  <script src="assets/js/main.js"></script>

</body>

</html>